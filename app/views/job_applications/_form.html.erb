<%= form_with(model: job_application, class: "space-y-6") do |form| %>
  <% if job_application.errors.any? %>
    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 text-red-800 dark:text-red-200 px-4 py-3 rounded relative" role="alert">
      <strong class="font-bold">Errors prevented this application from being saved:</strong>
      <ul class="mt-2 list-disc list-inside">
        <% job_application.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :company_name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.text_field :company_name, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "e.g., Tech Corp", required: true %>
    </div>

    <div>
      <%= form.label :job_title, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.text_field :job_title, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "e.g., Senior Software Engineer", required: true %>
    </div>
  </div>

  <div>
    <%= form.label :application_link, "Application/Job Posting Link", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= form.url_field :application_link, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "https://..." %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :application_date, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.date_field :application_date, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", required: true %>
    </div>

    <div>
      <%= form.label :current_status, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.select :current_status,
          JobApplication.current_statuses.keys.map { |status| [status.titleize, status] },
          {},
          class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500" %>
    </div>
  </div>

  <div id="rejected-stage-field" style="<%= 'display: none;' unless job_application.current_status == 'rejected' %>">
    <%= form.label :rejected_at_stage, "Rejected at Stage", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= form.select :rejected_at_stage,
        JobApplication.rejected_at_stages.keys.map { |stage| [stage.to_s.gsub('rejected_at_', '').titleize, stage] },
        { include_blank: "Select stage..." },
        class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500" %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :salary_range_min, "Minimum Salary", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.number_field :salary_range_min, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "50000", step: 1000 %>
    </div>

    <div>
      <%= form.label :salary_range_max, "Maximum Salary", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.number_field :salary_range_max, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "80000", step: 1000 %>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :contact_name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.text_field :contact_name, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "Recruiter or HR contact" %>
    </div>

    <div>
      <%= form.label :contact_email, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
      <%= form.email_field :contact_email, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "contact@company.com" %>
    </div>
  </div>

  <div>
    <%= form.label :follow_up_date, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= form.date_field :follow_up_date, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500" %>
  </div>

  <div>
    <%= form.label :notes, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= form.text_area :notes, rows: 4, class: "w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-teal-500 focus:border-teal-500", placeholder: "Any additional notes about this application..." %>
  </div>

  <div class="flex items-center justify-end space-x-4">
    <%= link_to "Cancel", job_applications_path, class: "px-4 py-2 text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white" %>
    <%= form.submit class: "bg-teal-600 hover:bg-teal-700 text-white px-6 py-2 rounded-lg font-semibold cursor-pointer" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const statusField = document.querySelector('select[name="job_application[current_status]"]');
    const rejectedStageField = document.getElementById('rejected-stage-field');

    if (statusField && rejectedStageField) {
      statusField.addEventListener('change', function() {
        if (this.value === 'rejected') {
          rejectedStageField.style.display = 'block';
        } else {
          rejectedStageField.style.display = 'none';
        }
      });
    }
  });
</script>
